<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnosi Differenziale Lesioni Cutanee</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 {
      color: #1e40af;
      font-size: 1.875rem;
      font-weight: bold;
    }
    .selector-panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 24px;
    }
    .selector-panel h2 {
      font-size: 1.125rem;
      color: #374151;
      margin-bottom: 12px;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .condition-button {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .condition-button.active {
      background-color: #2563eb;
      color: white;
    }
    .condition-button.inactive {
      background-color: #e5e7eb;
      color: #1f2937;
    }
    .condition-button.inactive:hover {
      background-color: #d1d5db;
    }
    .table-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      background-color: #dbeafe;
      color: #374151;
      font-weight: 600;
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    .data-table tr:nth-child(even) {
      background-color: #f9fafb;
    }
    .data-table tr:hover {
      background-color: #f3f4f6;
    }
    .row-header {
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .row-header span {
      margin-right: 8px;
    }
    .truncated {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .full-text {
      white-space: normal;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
    }
    .error-box {
      background-color: #fee2e2;
      border-radius: 8px;
      padding: 16px;
      max-width: 400px;
      text-align: center;
      color: #b91c1c;
    }
    .instructions {
      margin-top: 24px;
      background-color: #eff6ff;
      padding: 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      color: #4b5563;
    }
    .instructions ul {
      margin-top: 8px;
      margin-left: 20px;
      list-style-type: disc;
    }
    .instructions li {
      margin-bottom: 4px;
    }
    .file-input-container {
      margin: 20px 0;
      text-align: center;
    }
    .file-input-label {
      background-color: #2563eb;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
      transition: background-color 0.2s;
    }
    .file-input-label:hover {
      background-color: #1d4ed8;
    }
    .file-input {
      display: none;
    }
    .file-name {
      margin-top: 8px;
      font-size: 0.875rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const App = () => {
      const [data, setData] = useState([]);
      const [headers, setHeaders] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [activeConditions, setActiveConditions] = useState([]);
      const [expandedRows, setExpandedRows] = useState({});
      const [fileName, setFileName] = useState('');
      
      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        // Verificare che sia un file Excel
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
          setError('Il file deve essere in formato Excel (.xlsx o .xls)');
          return;
        }
        
        setFileName(file.name);
        setLoading(true);
        setError(null);
        
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            processExcelFile(data);
          } catch (err) {
            console.error('Errore nella lettura del file:', err);
            setError('Si è verificato un errore nella lettura del file.');
            setLoading(false);
          }
        };
        
        reader.onerror = () => {
          setError('Si è verificato un errore nella lettura del file.');
          setLoading(false);
        };
        
        reader.readAsArrayBuffer(file);
      };
      
      const processExcelFile = (data) => {
        try {
          const workbook = XLSX.read(data, {
            cellStyles: true,
            cellDates: true,
            cellNF: true,
          });
          
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          // Convertire in array di oggetti
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          if (jsonData.length > 0) {
            const headerRow = jsonData[0].filter(h => h !== null && h !== undefined);
            setHeaders(headerRow);
            
            // Impostare le prime due condizioni come attive di default (se disponibili)
            if (headerRow.length > 2) {
              setActiveConditions([headerRow[1], headerRow[2]]);
            } else if (headerRow.length > 1) {
              setActiveConditions([headerRow[1]]);
            }
            
            setData(jsonData.slice(1).filter(row => row.length > 0)); // Rimuovere l'header e le righe vuote
          } else {
            setError('Il file non contiene dati validi.');
          }
          
          setLoading(false);
        } catch (err) {
          console.error('Errore nell\'elaborazione del file Excel:', err);
          setError('Si è verificato un errore nell\'elaborazione del file Excel.');
          setLoading(false);
        }
      };
      
      const toggleCondition = (condition) => {
        setActiveConditions(prev => {
          if (prev.includes(condition)) {
            return prev.filter(c => c !== condition);
          } else {
            return [...prev, condition];
          }
        });
      };
      
      const toggleRowExpand = (index) => {
        setExpandedRows(prev => ({
          ...prev,
          [index]: !prev[index]
        }));
      };
      
      const getConditionIndex = (condition) => {
        return headers.findIndex(h => h === condition);
      };
      
      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            <p>Caricamento dati in corso...</p>
          </div>
        );
      }
      
      if (error) {
        return (
          <div className="error-container">
            <div className="error-box">
              <p><strong>Errore</strong></p>
              <p>{error}</p>
              <button 
                onClick={() => setError(null)} 
                style={{ marginTop: '10px', padding: '5px 10px', backgroundColor: '#ef4444', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
              >
                Riprova
              </button>
            </div>
          </div>
        );
      }
      
      return (
        <div className="app-container">
          <div className="header">
            <h1>Diagnosi Differenziale delle Lesioni Cutanee</h1>
          </div>
          
          <div className="file-input-container">
            <label className="file-input-label">
              Carica il file Excel
              <input 
                type="file" 
                className="file-input" 
                accept=".xlsx, .xls" 
                onChange={handleFileUpload} 
              />
            </label>
            {fileName && <div className="file-name">File selezionato: {fileName}</div>}
          </div>
          
          {data.length > 0 && (
            <>
              <div className="selector-panel">
                <h2>Seleziona le condizioni da confrontare:</h2>
                <div className="button-group">
                  {headers.slice(1).map((condition, index) => (
                    <button
                      key={index}
                      className={`condition-button ${activeConditions.includes(condition) ? 'active' : 'inactive'}`}
                      onClick={() => toggleCondition(condition)}
                    >
                      {condition}
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="table-container">
                <div style={{ overflowX: 'auto' }}>
                  <table className="data-table">
                    <thead>
                      <tr>
                        <th style={{ width: '25%' }}>Caratteristica</th>
                        {activeConditions.map((condition, index) => (
                          <th key={index}>{condition}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {data.map((row, rowIndex) => {
                        const caratteristica = row[0];
                        const isExpanded = expandedRows[rowIndex] === true;
                        
                        return (
                          <tr key={rowIndex}>
                            <td onClick={() => toggleRowExpand(rowIndex)}>
                              <div className="row-header">
                                <span>{isExpanded ? '▼' : '▶'}</span>
                                {caratteristica}
                              </div>
                            </td>
                            {activeConditions.map((condition, condIndex) => {
                              const cellIndex = getConditionIndex(condition);
                              const content = row[cellIndex] || '';
                              
                              return (
                                <td 
                                  key={condIndex} 
                                  onClick={() => toggleRowExpand(rowIndex)}
                                >
                                  <div className={isExpanded ? 'full-text' : 'truncated'}>
                                    {content}
                                  </div>
                                </td>
                              );
                            })}
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div className="instructions">
                <p><strong>Come utilizzare questa app:</strong></p>
                <ul>
                  <li>Seleziona le condizioni da confrontare utilizzando i pulsanti in alto</li>
                  <li>Clicca su una riga per espandere/comprimere il testo completo</li>
                  <li>Confronta le caratteristiche di ciascuna condizione nella tabella</li>
                </ul>
              </div>
            </>
          )}
          
          {data.length === 0 && !loading && !error && (
            <div style={{ textAlign: 'center', marginTop: '50px', color: '#6b7280' }}>
              <p>Carica un file Excel per visualizzare i dati.</p>
              <p style={{ fontSize: '0.875rem', marginTop: '10px' }}>
                Il file dovrebbe contenere colonne per le diverse condizioni dermatologiche e righe per le loro caratteristiche.
              </p>
            </div>
          )}
        </div>
      );
    };
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
